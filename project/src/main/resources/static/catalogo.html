<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo e Comparador de Preços</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { background-color: #f8f9fa; }
        .product-card { transition: box-shadow .3s; }
        .product-card:hover { box-shadow: 0 .5rem 1rem rgba(0,0,0,.15); }
        .product-card-img { height: 180px; object-fit: contain; padding: 1rem; }
        .shopping-list-container { position: sticky; top: 20px; }
        .cart-item-img { width: 50px; height: 50px; object-fit: contain; }
        .price-spoiler { font-size: 0.85em; }
        .price-spoiler .list-group-item { padding: 0.5rem 0.75rem; }
        .best-price { color: #198754; font-weight: bold; }
        .comparison-summary { cursor: pointer; }
        .comparison-card.best-complete { border-left: 4px solid #198754; }
        .comparison-card.incomplete { border-left: 4px solid #ffc107; }
        .modal-price { font-weight: bold; color: #198754; }
        .modal-original-price { text-decoration: line-through; font-size: 0.9em; color: #6c757d; }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 1056;
            display: flex; align-items: center; justify-content: center;
            color: white;
        }
        .comparison-summary .fw-bold { font-size: 0.9rem; }
        .comparison-summary .small { font-size: 0.75rem; }
        .comparison-summary .h5 { font-size: 1.05rem; margin-bottom: 0; }
        .comparison-details .list-group-item {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <i class="bi bi-bullseye"></i>
            Meu Sistema
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="catalogo.html">Catálogo & Compras</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="guia-de-compras.html">Guia de Compras</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="ofertas.html">Melhores Ofertas</a>
                </li>
            </ul>
            <ul class="navbar-nav">
                 <li class="nav-item">
                    <a class="nav-link" href="indexacao.html">
                        <i class="bi bi-sliders"></i> Indexação
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="index.html">
                        <i class="bi bi-pencil-square"></i> Gestão
                    </a>
                </li>
            </ul>
        </div>
    </div>
</nav>
    <div id="loading-overlay">
        <div class="text-center">
            <div class="spinner-border mb-3" role="status"></div>
            <h4>Carregando todos os produtos...</h4>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container"><a class="navbar-brand" href="#">Meu Catálogo de Compras</a></div>
    </nav>
    <main class="container mt-4">
        <div class="row">
            <div class="col-lg-8">
                <h2>Produtos</h2>
                <div class="input-group mb-4">
                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                    <input type="text" id="pesquisa-catalogo-input" class="form-control" placeholder="Buscar por nome do produto...">
                </div>
                <div id="catalogo-produtos" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4"></div>
                <nav id="paginacao" class="mt-4 d-flex justify-content-center"></nav>
            </div>
            <div class="col-lg-4">
                <div class="shopping-list-container">
                    <div class="card">
                        <div class="card-body">
                            <h4 class="card-title"><span><i class="bi bi-cart3"></i> Minha Lista</span></h4>
                            <ul id="lista-compras-items" class="list-group list-group-flush mb-3"></ul>
                            <hr>
                            <h5 class="card-title mt-3"><span><i class="bi bi-bar-chart-line-fill"></i> Comparativo de Preços</span></h5>
                            <div id="comparison-results" class="accordion">
                                <div class="text-center text-muted small p-3">Adicione itens na lista para comparar os preços.</div>
                            </div>
                        </div>
                        <div class="card-footer text-end">
                            <button id="btn-limpar-lista" class="btn btn-sm btn-outline-danger">Limpar Lista</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="modal fade" id="price-modal" tabindex="-1"><div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="price-modal-label">Comparar Preços</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="price-comparison-body"></div></div></div></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const BASE_URL = `http://${window.location.hostname}`;
        const API_REFERENCIAS_URL = `${BASE_URL}:8080/produtos/referencias`;
        const API_SCRAPING_URL = `${BASE_URL}:8080/produtos/scraping`;
        
        const catalogoContainer = document.getElementById('catalogo-produtos');
        const pesquisaInput = document.getElementById('pesquisa-catalogo-input');
        const paginacaoContainer = document.getElementById('paginacao');
        const listaComprasContainer = document.getElementById('lista-compras-items');
        const comparisonContainer = document.getElementById('comparison-results');
        const loadingOverlay = document.getElementById('loading-overlay');
        const priceModalElement = document.getElementById('price-modal');
        const priceModal = new bootstrap.Modal(priceModalElement);
        const btnLimparLista = document.getElementById('btn-limpar-lista');
        
        let debounceTimer;
        const PAGE_SIZE = 12;

        let estado = {
            todosOsProdutosReferencia: [],
            produtosFiltrados: [],
            listaDeCompras: [],
            comparativoPrecos: []
        };
        
        const carregarTodosOsProdutos = async () => {
            try {
                const firstPageResponse = await fetch(`${API_REFERENCIAS_URL}/listar?page=0&size=100`);
                if (!firstPageResponse.ok) throw new Error('Falha ao buscar a primeira página de produtos.');
                const firstPageData = await firstPageResponse.json();
                let allProducts = firstPageData.content;
                const totalPages = firstPageData.totalPages;
                if (totalPages > 1) {
                    const pagePromises = [];
                    for (let i = 1; i < totalPages; i++) {
                        pagePromises.push(fetch(`${API_REFERENCIAS_URL}/listar?page=${i}&size=100`).then(res => res.json()));
                    }
                    const otherPagesData = await Promise.all(pagePromises);
                    otherPagesData.forEach(pageData => {
                        allProducts.push(...pageData.content);
                    });
                }
                estado.todosOsProdutosReferencia = allProducts.filter(p => p.nome !== 'NOT INDEX');
                estado.produtosFiltrados = estado.todosOsProdutosReferencia;
                exibirPaginaDeProdutos(0);
                loadingOverlay.style.display = 'none';
            } catch (error) {
                console.error("Erro fatal ao carregar produtos:", error);
                loadingOverlay.innerHTML = `<div class="alert alert-danger m-3">${error.message}<br><br>Verifique se a API está rodando e recarregue a página.</div>`;
            }
        };

        const exibirPaginaDeProdutos = (page = 0) => {
            const source = estado.produtosFiltrados;
            const start = page * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const produtosDaPagina = source.slice(start, end);
            renderizarCatalogo(produtosDaPagina);
            renderizarPaginacao(page, source.length);
        };

        const formatarData = dataString => dataString ? new Date(dataString).toLocaleDateString("pt-BR") : "";
        const formatarPreco = preco => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(preco);
        
        const renderizarCatalogo = async (produtos) => {
            catalogoContainer.innerHTML = "";
            if (produtos.length === 0) {
                catalogoContainer.innerHTML = '<div class="col-12 text-center text-muted mt-4">Nenhum produto encontrado.</div>';
                return;
            }
            const cardPromises = produtos.map(async (produto) => {
                let spoilerHtml = '<p class="text-muted small mt-2">Buscando preços...</p>';
                try {
                    const res = await fetch(`${API_SCRAPING_URL}/melhores-ofertas/${produto.id}`);
                    if (!res.ok) throw new Error('Falha ao buscar ofertas');
                    const melhoresOfertas = await res.json();
                    if (melhoresOfertas && melhoresOfertas.length > 0) {
                        const top3 = melhoresOfertas.sort((a, b) => a.precoEspecial - b.precoEspecial).slice(0, 3);
                        spoilerHtml = `<ul class="list-group list-group-flush price-spoiler mt-2">${top3.map((p, index) => `<li class="list-group-item d-flex justify-content-between align-items-center"><div><strong class="${index === 0 ? "best-price" : ""}">${formatarPreco(p.precoEspecial)}</strong><small class="d-block text-muted">${p.estabelecimentoNome}</small></div><small class="text-muted">${formatarData(p.dataScraping)}</small></li>`).join('')}</ul>`;
                    } else {
                        spoilerHtml = '<p class="text-muted small mt-2">Nenhum preço encontrado.</p>';
                    }
                } catch (error) {
                    spoilerHtml = '<p class="text-danger small mt-2">Erro ao buscar preços.</p>';
                }
                return `<div class="col"><div class="card h-100 product-card"><img src="${produto.urlImg || "https://via.placeholder.com/200"}" class="card-img-top product-card-img" alt="${produto.nome}"><div class="card-body d-flex flex-column"><h6 class="card-title">${produto.nome}</h6><p class="card-text text-muted small mb-0">${produto.marca || "Marca não informada"}</p>${spoilerHtml}<div class="mt-auto pt-2"><button class="btn btn-sm btn-outline-secondary w-100 mb-2 btn-ver-precos" data-id="${produto.id}" data-nome="${produto.nome}">Ver Todos os Preços</button><button class="btn btn-sm btn-primary w-100 btn-add-lista" data-id="${produto.id}" data-nome="${produto.nome}" data-img="${produto.urlImg || ""}">Adicionar à Lista</button></div></div></div></div>`;
            });
            const cardsHtml = await Promise.all(cardPromises);
            catalogoContainer.innerHTML = cardsHtml.join('');
        };

        const renderizarPaginacao = (currentPage, totalItems) => {
            paginacaoContainer.innerHTML = "";
            const totalPages = Math.ceil(totalItems / PAGE_SIZE);
            if (totalPages <= 1) return;
            const ul = document.createElement('ul');
            ul.className = 'pagination';
            ul.innerHTML = `<li class="page-item ${currentPage === 0 ? "disabled" : ""}"><a class="page-link" href="#" data-page="${currentPage - 1}">Anterior</a></li><li class="page-item disabled"><span class="page-link">Página ${currentPage + 1} de ${totalPages}</span></li><li class="page-item ${currentPage >= totalPages - 1 ? "disabled" : ""}"><a class="page-link" href="#" data-page="${currentPage + 1}">Próximo</a></li>`;
            paginacaoContainer.appendChild(ul);
        };
        
        const renderizarListaDeCompras = () => {
            listaComprasContainer.innerHTML = "";
            if (estado.listaDeCompras.length === 0) {
                listaComprasContainer.innerHTML = '<li class="list-group-item text-center text-muted">Sua lista está vazia.</li>';
                return;
            }
            estado.listaDeCompras.forEach(item => {
                const li = document.createElement('li');
                li.className = "list-group-item d-flex align-items-center";
                li.innerHTML = `<img src="${item.urlImg || "https://via.placeholder.com/50"}" alt="${item.nome}" class="cart-item-img me-2"><div class="flex-grow-1"><div class="small">${item.nome}</div><div class="d-flex align-items-center mt-1"><button class="btn btn-sm btn-outline-secondary py-0 px-2 btn-change-qty" data-id="${item.id}" data-change="-1">-</button><span class="mx-2">${item.quantidade}</span><button class="btn btn-sm btn-outline-secondary py-0 px-2 btn-change-qty" data-id="${item.id}" data-change="1">+</button></div></div><button class="btn btn-sm btn-outline-danger border-0 btn-remove-item" data-id="${item.id}"><i class="bi bi-trash"></i></button>`;
                listaComprasContainer.appendChild(li);
            });
        };

        const adicionarNaLista = (id, nome, img) => {
            const itemExistente = estado.listaDeCompras.find(item => item.id === id);
            if (itemExistente) {
                itemExistente.quantidade++;
            } else {
                estado.listaDeCompras.push({ id, nome, urlImg: img, quantidade: 1 });
            }
            renderizarListaDeCompras();
            debouncedAtualizarComparativo();
        };

        const mudarQuantidade = (id, change) => {
            const item = estado.listaDeCompras.find(item => item.id === id);
            if (item) {
                item.quantidade += change;
                if (item.quantidade <= 0) {
                    removerDaLista(id);
                } else {
                    renderizarListaDeCompras();
                    debouncedAtualizarComparativo();
                }
            }
        };
        
        const removerDaLista = (id) => {
            estado.listaDeCompras = estado.listaDeCompras.filter(item => item.id !== id);
            renderizarListaDeCompras();
            debouncedAtualizarComparativo();
        };

        const abrirModalPrecos = async (id, nome) => {
            const modalTitle = document.getElementById('price-modal-label');
            const modalBody = document.getElementById('price-comparison-body');
            modalTitle.textContent = `Comparando Preços: ${nome}`;
            modalBody.innerHTML = '<div class="text-center"><div class="spinner-border spinner-border-sm"></div> Carregando...</div>';
            priceModal.show();
            try {
                const response = await fetch(`${API_SCRAPING_URL}/melhores-ofertas/${id}`);
                const ofertas = await response.json();
                renderizarComparacaoPrecos(ofertas, modalBody);
            } catch (error) {
                console.error("Erro ao buscar preços:", error);
                modalBody.innerHTML = '<div class="alert alert-warning">Não foi possível carregar os preços.</div>';
            }
        };

        const renderizarComparacaoPrecos = (ofertas, container) => {
            if (ofertas.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Nenhuma oferta encontrada para este produto.</div>';
                return;
            }
            ofertas.sort((a, b) => a.precoEspecial - b.precoEspecial);
            container.innerHTML = `<table class="table table-sm table-striped align-middle"><thead><tr><th>Supermercado</th><th>Unidade</th><th>Produto</th><th class="text-end">Preço</th></tr></thead><tbody>${ofertas.map(oferta => {
                let precoHtml = `<span class="modal-price">${formatarPreco(oferta.precoEspecial)}</span>`;
                if (oferta.precoEspecial < oferta.preco) {
                    precoHtml += ` <span class="modal-original-price">${formatarPreco(oferta.preco)}</span>`;
                }
                return `<tr><td>${oferta.estabelecimentoNome}</td><td>${oferta.unidadeNome}</td><td><div class="d-flex align-items-center"><span class="small">${oferta.nomeProduto}</span></div></td><td class="text-end">${precoHtml}</td></tr>`;
            }).join("")}</tbody></table>`;
        };
        
        const atualizarComparativo = async () => {
            if (estado.listaDeCompras.length === 0) {
                comparisonContainer.innerHTML = '<div class="text-center text-muted small p-3">Adicione itens na lista para comparar.</div>';
                return;
            }
            comparisonContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border spinner-border-sm"></div><span class="ms-2 small">Calculando...</span></div>';
            try {
                const itemPromises = estado.listaDeCompras.map(item =>
                    fetch(`${API_SCRAPING_URL}/melhores-ofertas/${item.id}`).then(res => res.ok ? res.json() : [])
                );
                const todasAsOfertasPorItem = await Promise.all(itemPromises);
                
                let todasUnidades = {};
                const ofertasMap = new Map();
                estado.listaDeCompras.forEach((item, index) => {
                    ofertasMap.set(item.id, todasAsOfertasPorItem[index]);
                    todasAsOfertasPorItem[index].forEach(oferta => {
                        if (!todasUnidades[oferta.unidadeId]) {
                            todasUnidades[oferta.unidadeId] = { id: oferta.unidadeId, nome: oferta.unidadeNome, estabelecimento: oferta.estabelecimentoNome };
                        }
                    });
                });

                const comparativo = Object.values(todasUnidades).map(unidade => {
                    let subtotal = 0;
                    let itensEncontrados = [];
                    let itensFaltantes = [];
                    estado.listaDeCompras.forEach(itemDaLista => {
                        const ofertasDoItem = ofertasMap.get(itemDaLista.id);
                        const ofertaNestaUnidade = ofertasDoItem.find(o => o.unidadeId === unidade.id);
                        if (ofertaNestaUnidade) {
                            subtotal += ofertaNestaUnidade.precoEspecial * itemDaLista.quantidade;
                            itensEncontrados.push({ ...itemDaLista, preco: ofertaNestaUnidade.precoEspecial });
                        } else {
                            itensFaltantes.push(itemDaLista);
                        }
                    });
                    return { unidadeId: unidade.id, unidadeNome: unidade.nome, estabelecimentoNome: unidade.estabelecimento, subtotal, itensEncontrados, itensFaltantes };
                });
                
                estado.comparativoPrecos = comparativo;
                renderizarComparativo();
            } catch (error) {
                console.error("Erro ao comparar preços:", error);
                comparisonContainer.innerHTML = `<div class="alert alert-warning small">${error.message}</div>`;
            }
        };

        const renderizarComparativo = () => {
            if (estado.comparativoPrecos.length === 0) {
                comparisonContainer.innerHTML = '<div class="text-center text-muted small p-3">Nenhum supermercado com os itens da lista.</div>';
                return;
            }
            const lojasCompletas = estado.comparativoPrecos.filter(c => c.itensFaltantes.length === 0);
            const menorSubtotalCompleto = lojasCompletas.length > 0 ? Math.min(...lojasCompletas.map(c => c.subtotal)) : Infinity;
            
            estado.comparativoPrecos.sort((a, b) => {
                const aIncompleto = a.itensFaltantes.length > 0;
                const bIncompleto = b.itensFaltantes.length > 0;
                if (aIncompleto && !bIncompleto) return 1;
                if (!aIncompleto && bIncompleto) return -1;
                return a.subtotal - b.subtotal;
            });

            comparisonContainer.innerHTML = estado.comparativoPrecos.map((comp, index) => {
                const isBest = comp.subtotal === menorSubtotalCompleto;
                const isIncomplete = comp.itensFaltantes.length > 0;
                const cardClass = isBest ? 'best-complete' : (isIncomplete ? 'incomplete' : '');
                const detailsId = `details-${comp.unidadeId}`;
                const itemsEncontradosHtml = comp.itensEncontrados.map(item => `<li class="list-group-item d-flex justify-content-between"><span class="small">${item.quantidade}x ${item.nome}</span><span class="small fw-bold">${formatarPreco(item.preco * item.quantidade)}</span></li>`).join('');
                const itemsFaltantesHtml = comp.itensFaltantes.map(item => `<li class="list-group-item d-flex justify-content-between"><span class="small">${item.quantidade}x ${item.nome}</span><span class="small text-danger fw-bold">Não encontrado</span></li>`).join('');

                return `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <div class="card card-body p-0 comparison-card ${cardClass}">
                            <div class="d-flex justify-content-between align-items-center p-2 comparison-summary" data-bs-toggle="collapse" data-bs-target="#${detailsId}">
                                <div>
                                    <div class="fw-bold">${comp.estabelecimentoNome}</div>
                                    <div class="small text-muted">${comp.unidadeNome}</div>
                                    ${isIncomplete ? `<div class="small text-warning-emphasis"><i class="bi bi-exclamation-triangle-fill"></i> ${comp.itensFaltantes.length} item(ns) faltante(s)</div>` : ''}
                                </div>
                                <div class="text-end">
                                    <div class="h5 mb-0 ${isBest ? 'best-price' : ''}">${formatarPreco(comp.subtotal)}</div>
                                    ${isBest ? '<span class="badge bg-success small">Melhor Opção</span>' : ''}
                                </div>
                            </div>
                            <div id="${detailsId}" class="accordion-collapse collapse comparison-details" data-bs-parent="#comparison-results">
                                <ul class="list-group list-group-flush small">${itemsEncontradosHtml}${itemsFaltantesHtml}</ul>
                                <div class="p-2">
                                    <button class="btn btn-primary btn-sm w-100 btn-create-guide" data-unidade-id="${comp.unidadeId}">
                                        <i class="bi bi-list-check"></i> Criar Guia para esta Loja
                                    </button>
                                </div>
                            </div>
                        </div>
                    </h2>
                </div>`;
            }).join('');
        };
        const debouncedAtualizarComparativo = () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(atualizarComparativo, 700); };
        
        pesquisaInput.addEventListener('keyup', e => {
            const termo = e.target.value.toLowerCase();
            estado.produtosFiltrados = estado.todosOsProdutosReferencia.filter(p => p.nome.toLowerCase().includes(termo));
            exibirPaginaDeProdutos(0);
        });
        paginacaoContainer.addEventListener("click", e => {
            e.preventDefault();
            const t = e.target.closest('a');
            if (t && !t.parentElement.classList.contains("disabled")) {
                exibirPaginaDeProdutos(parseInt(t.dataset.page, 10));
            }
        });
        catalogoContainer.addEventListener("click", e => {
            const t = e.target;
            if (t.classList.contains("btn-add-lista")) {
                const e = parseInt(t.dataset.id, 10);
                adicionarNaLista(e, t.dataset.nome, t.dataset.img);
            }
            if (t.classList.contains("btn-ver-precos")) {
                const e = parseInt(t.dataset.id, 10);
                abrirModalPrecos(e, t.dataset.nome);
            }
        });
        listaComprasContainer.addEventListener("click", e => {
            const t = e.target.closest("button");
            if (!t) return;
            const a = parseInt(t.dataset.id, 10);
            if (t.classList.contains("btn-change-qty")) mudarQuantidade(a, parseInt(t.dataset.change, 10));
            if (t.classList.contains("btn-remove-item")) removerDaLista(a);
        });
        btnLimparLista.addEventListener("click", () => {
            if (confirm("Tem certeza que deseja limpar toda a lista?")) {
                estado.listaDeCompras = [];
                renderizarListaDeCompras();
                debouncedAtualizarComparativo();
            }
        });
        comparisonContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-create-guide')) {
                const unidadeId = parseInt(e.target.dataset.unidadeId, 10);
                const guideData = estado.comparativoPrecos.find(c => c.unidadeId === unidadeId);
                if (guideData) {
                    localStorage.setItem('shoppingGuideData', JSON.stringify(guideData));
                    window.location.href = 'guia-de-compras.html';
                }
            }
        });
        
        carregarTodosOsProdutos();
    });
    </script>
</body>
</html>