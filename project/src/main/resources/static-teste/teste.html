<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corrigir Produtos Não Indexados</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }
        /* Garante que a tabela não exceda a altura e tenha scroll */
        .table-container {
            max-height: 45vh;
            overflow-y: auto;
        }
        /* Estilo para o item de sugestão ativo */
        .suggestion-item.active {
            background-color: #e9ecef;
            border-color: #dee2e6;
            font-weight: bold;
        }
        /* Efeito de hover para os itens de sugestão */
        .suggestion-item:hover {
            background-color: #f1f3f5;
            cursor: pointer;
        }
        /* Toast para notificações */
        #toast-container {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            z-index: 1055;
        }
    </style>
</head>
<body class="container py-4">

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Produtos Não Indexados</h2>
    <button class="btn btn-secondary" onclick="carregarProdutos()">
        <i class="bi bi-arrow-clockwise"></i> Recarregar
    </button>
</div>

<!-- Accordion para Ações -->
<div class="accordion shadow-sm mb-4" id="actionsAccordion">
    <!-- Item do Accordion: Iniciar Scraping -->
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                <i class="bi bi-robot me-2"></i> Iniciar Novo Scraping
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#actionsAccordion">
            <div class="accordion-body">
                <form id="form-scraping">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-3"><label for="scraping-page" class="form-label">Página</label><input type="number" class="form-control" id="scraping-page" value="1" min="1" required></div>
                        <div class="col-md-3"><label for="scraping-item" class="form-label">Itens</label><input type="number" class="form-control" id="scraping-item" value="24" min="1" required></div>
                        <div class="col-md-3"><label for="scraping-categoria" class="form-label">Categoria</label><input type="number" class="form-control" id="scraping-categoria" value="1" min="1" required></div>
                        <div class="col-md-3"><button type="submit" class="btn btn-info w-100"><i class="bi bi-play-circle"></i> Iniciar</button></div>
                    </div>
                </form>
                <div id="scraping-progress-container" class="mt-3 d-none">
                    <div class="progress" role="progressbar"><div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 0%"></div></div>
                    <small class="text-muted">Scraping em andamento. A lista será atualizada automaticamente.</small>
                </div>
            </div>
        </div>
    </div>
    <!-- Item do Accordion: Criar Referência -->
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingTwo">
            <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                <i class="bi bi-plus-circle me-2"></i> Criar Nova Referência
            </button>
        </h2>
        <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#actionsAccordion">
            <div class="accordion-body">
                <form id="form-criar-referencia">
                    <div class="row g-3">
                        <div class="col-md-6"><label for="ref-create-nome" class="form-label">Nome do Produto</label><input type="text" class="form-control" id="ref-create-nome" required></div>
                        <div class="col-md-6"><label for="ref-create-marca" class="form-label">Marca</label><input type="text" class="form-control" id="ref-create-marca"></div>
                        <div class="col-md-12"><label for="ref-create-urlImg" class="form-label">URL da Imagem</label><input type="url" class="form-control" id="ref-create-urlImg"></div>
                        <div class="col-md-12"><label for="ref-create-descricao" class="form-label">Descrição</label><textarea class="form-control" id="ref-create-descricao" rows="2"></textarea></div>
                        <div class="col-md-4"><label for="ref-create-unidadeMedida" class="form-label">Unidade Medida</label><input type="text" class="form-control" id="ref-create-unidadeMedida" placeholder="ex: kg, g, L, ml, un"></div>
                        <div class="col-md-4"><label for="ref-create-valorMedida" class="form-label">Valor Medida</label><input type="number" step="0.01" class="form-control" id="ref-create-valorMedida"></div>
                        <div class="col-md-4"><label for="ref-create-codigoBarra" class="form-label">Código de Barras</label><input type="text" class="form-control" id="ref-create-codigoBarra"></div>
                        <div class="col-12 text-end"><button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Salvar Referência</button></div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Tabela com scroll -->
<div class="table-container shadow-sm bg-white rounded">
    <table class="table table-hover table-bordered mb-0" id="tabela-produtos">
        <thead class="table-light sticky-top">
        <tr>
            <th style="width: 25%;">Estabelecimento</th>
            <th style="width: 35%;">Produto</th>
            <th style="width: 10%;">Imagem</th>
            <th style="width: 15%;">Ref. Atual</th>
            <th style="width: 15%;">Ação</th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- Seção de Correção (inicialmente oculta) -->
<div id="correction-section" class="mt-4 d-none">
    <hr/>
    <h3 class="mb-3">Corrigir Produto</h3>
    <div class="row g-4">
        <div class="col-lg-6"><div class="card h-100 shadow-sm"><div class="card-header bg-warning text-dark fw-bold">Produto Original</div><div class="card-body"><p><strong>Estabelecimento:</strong> <span id="original-estabelecimento"></span></p><p><strong>Produto:</strong> <span id="original-nomeProduto"></span></p><p class="mb-0"><strong>Referência Atual:</strong> <span id="original-refAtual" class="text-danger fw-bold"></span></p><img id="original-imgProduto" src="" alt="Imagem Original" class="img-fluid rounded mt-2" style="max-height: 150px;"></div></div></div>
        <div class="col-lg-6"><div class="card h-100 shadow-sm"><div class="card-header bg-info text-dark fw-bold">Nova Referência</div><div class="card-body" id="nova-referencia-card"><p class="text-muted">Selecione uma sugestão ou use a busca.</p><div id="nova-referencia-content" class="d-none"><p><strong>ID:</strong> <span id="ref-id"></span></p><p><strong>Nome:</strong> <span id="ref-nome"></span></p><p><strong>Marca:</strong> <span id="ref-marca"></span></p><img id="ref-img" src="" alt="Imagem Referência" class="img-fluid rounded mt-2" style="max-height: 150px;"></div></div></div></div>
    </div>
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <div class="row align-items-end"><div class="col-md-8"><label for="search-input" class="form-label fw-bold">Buscar Referência</label><input type="text" id="search-input" class="form-control" placeholder="Digite para filtrar as referências..."></div><div class="col-md-4 text-end"><button id="update-button" class="btn btn-success w-100 mt-3 mt-md-0" disabled><i class="bi bi-check-circle-fill"></i> Atualizar Referência</button></div></div>
            <h5 class="mt-4">Sugestões</h5><div id="suggestions-container" class="list-group" style="max-height: 250px; overflow-y: auto;"></div>
        </div>
    </div>
</div>

<!-- Container para notificações (Toast) -->
<div id="toast-container"></div>

<script>
    let allReferences = [];
    let currentProduct = null;
    let selectedReferenceId = null;
    let isScraping = false;

    function showToast(message, type = 'success') {
        const toastContainer = document.getElementById('toast-container');
        const toastId = 'toast-' + Date.now();
        const toastIcon = type === 'success' ? '<i class="bi bi-check-circle-fill me-2"></i>' : (type === 'danger' ? '<i class="bi bi-exclamation-triangle-fill me-2"></i>' : '<i class="bi bi-info-circle-fill me-2"></i>');
        const toastHtml = `<div id="${toastId}" class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body">${toastIcon} ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div></div>`;
        toastContainer.insertAdjacentHTML('beforeend', toastHtml);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 4000 });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastElement.remove());
    }

    async function carregarReferencias() {
        try {
            const resposta = await fetch('http://localhost:8080/scraping/produtos-referencia');
            if (!resposta.ok) throw new Error('Falha ao carregar referências.');
            allReferences = await resposta.json();
            allReferences.sort((a, b) => a.nome.localeCompare(b.nome));
        } catch (error) {
            console.error(error);
            showToast(error.message, 'danger');
        }
    }

    async function carregarProdutos() {
        try {
            const resposta = await fetch('http://localhost:8080/scraping/produtos-not-index');
            if (!resposta.ok) throw new Error('Falha ao carregar produtos.');
            const produtos = await resposta.json();
            const tbody = document.querySelector('#tabela-produtos tbody');
            tbody.innerHTML = '';
            if (produtos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted p-4">Nenhum produto para corrigir! 🎉</td></tr>';
                return;
            }
            produtos.forEach(produto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${produto.nomeEstabelecimento}</td><td>${produto.nomeProduto}</td><td><img src="${produto.urlImg}" alt="img" width="50" class="rounded" onerror="this.src='https://placehold.co/50x50/ccc/fff?text=N/A'"/></td><td class="text-danger">${produto.produtoReferenciaId ?? 'N/A'}</td><td><button class="btn btn-sm btn-primary" onclick='mostrarFormulario(${JSON.stringify(produto)})'><i class="bi bi-pencil-square"></i> Corrigir</button></td>`;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error(error);
            showToast(error.message, 'danger');
        }
    }

    function mostrarFormulario(produto) {
        currentProduct = produto;
        selectedReferenceId = null;
        document.getElementById('correction-section').classList.remove('d-none');
        document.getElementById('original-estabelecimento').textContent = produto.nomeEstabelecimento;
        document.getElementById('original-nomeProduto').textContent = produto.nomeProduto;
        document.getElementById('original-imgProduto').src = produto.urlImg;
        document.getElementById('original-refAtual').textContent = produto.produtoReferenciaId ?? 'N/A';
        clearNovaReferenciaCard();
        document.getElementById('update-button').disabled = true;
        document.getElementById('correction-section').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('search-input').value = '';
        buscarESugerirReferencias(produto.nomeProduto);
    }

    /**
     * ESTRATÉGIA DE SIMILARIDADE COM FILTRO DE STOP WORDS
     * Calcula um score ignorando palavras comuns (stop words) para focar nas palavras significativas.
     * @param {string} originalProductName - O nome do produto original.
     * @param {string} referenceName - O nome da referência a ser comparada.
     * @returns {number} - Um score de similaridade entre 0 e 1.
     */
    function calculateSimilarity(originalProductName, referenceName) {
        // Lista de palavras comuns a serem ignoradas na comparação.
        const stopWords = new Set(['de', 'a', 'o', 'e', 'do', 'da', 'em', 'um', 'para', 'com', 'não', 'uma', 'os', 'no', 'na', 'por', 'mais', 'as', 'kg', 'g', 'gr', 'l', 'lt', 'ml', 'un', 'unidade', 'caixa', 'cx', 'c', 's', 'oferta', 'especial', 'promocao', 'pague', 'leve', 'tipo', 'produto', 'referencia']);

        // Função que converte uma string em um conjunto de palavras (tokens) significativas.
        const getTokens = (str) => new Set(
            str.toLowerCase()
               .split(/[\s,.-]+/) // Divide a string em palavras
               .filter(token => token.length > 1 && !stopWords.has(token)) // Remove palavras curtas e stop words
        );

        const originalTokens = getTokens(originalProductName);
        const referenceTokens = getTokens(referenceName);

        // Se não houver palavras significativas, o score é 0.
        if (originalTokens.size === 0 || referenceTokens.size === 0) {
            return 0;
        }

        // Encontra as palavras em comum entre os dois nomes.
        const intersection = new Set([...originalTokens].filter(token => referenceTokens.has(token)));

        // A pontuação é a proporção de palavras correspondentes em relação ao total de palavras significativas do produto original.
        return intersection.size / originalTokens.size;
    }


    function buscarESugerirReferencias(searchTerm) {
        if (!searchTerm.trim()) {
            exibirSugestoes(allReferences.slice(0, 20));
            return;
        }
        const scoredReferences = allReferences.map(ref => ({ ...ref, score: calculateSimilarity(searchTerm, ref.nome) }));
        scoredReferences.sort((a, b) => b.score - a.score);
        exibirSugestoes(scoredReferences.filter(ref => ref.score > 0).slice(0, 30)); // Mostra apenas resultados com alguma correspondência.
    }

    function exibirSugestoes(suggestions) {
        const container = document.getElementById('suggestions-container');
        container.innerHTML = '';
        if (suggestions.length === 0) {
            container.innerHTML = '<p class="text-center text-muted p-3">Nenhuma referência encontrada.</p>';
            return;
        }
        suggestions.forEach(ref => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action suggestion-item';
            item.dataset.id = ref.id;
            const scoreDisplay = ref.score !== undefined ? `<small class="text-success fw-bold">Relevância: ${(ref.score * 100).toFixed(0)}%</small>` : `<small>ID: ${ref.id}</small>`;
            item.innerHTML = `<div class="d-flex w-100 justify-content-between"><h6 class="mb-1">${ref.nome}</h6>${scoreDisplay}</div><p class="mb-1">${ref.marca || 'Marca não informada'}</p>`;
            item.onclick = (e) => { e.preventDefault(); selecionarReferencia(ref.id); };
            container.appendChild(item);
        });
    }

    function selecionarReferencia(refId) {
        selectedReferenceId = refId;
        const refSelecionada = allReferences.find(r => r.id === refId);
        if (refSelecionada) {
            document.getElementById('ref-id').textContent = refSelecionada.id;
            document.getElementById('ref-nome').textContent = refSelecionada.nome || '-';
            document.getElementById('ref-marca').textContent = refSelecionada.marca || '-';
            document.getElementById('ref-img').src = refSelecionada.urlImg || '';
            document.getElementById('nova-referencia-card').querySelector('p.text-muted').classList.add('d-none');
            document.getElementById('nova-referencia-content').classList.remove('d-none');
        }
        document.getElementById('update-button').disabled = false;
        document.querySelectorAll('.suggestion-item').forEach(item => item.classList.remove('active'));
        document.querySelector(`.suggestion-item[data-id='${refId}']`).classList.add('active');
    }

    function clearNovaReferenciaCard() {
         document.getElementById('nova-referencia-card').querySelector('p.text-muted').classList.remove('d-none');
         document.getElementById('nova-referencia-content').classList.add('d-none');
    }

    async function atualizarProduto() {
        if (!currentProduct || !selectedReferenceId) { showToast('Produto ou referência não selecionados.', 'danger'); return; }
        const dto = { estabelecimento: currentProduct.nomeEstabelecimento, nomeProduto: currentProduct.nomeProduto, produtoReferenciaId: selectedReferenceId };
        try {
            const response = await fetch('http://localhost:8080/scraping/produtos-not-index', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(dto) });
            if (response.ok) {
                showToast('Produto atualizado com sucesso!');
                document.getElementById('correction-section').classList.add('d-none');
                currentProduct = null;
                carregarProdutos();
            } else {
                const errorData = await response.text();
                throw new Error(errorData || 'Erro ao atualizar produto.');
            }
        } catch (error) {
            console.error(error);
            showToast(error.message, 'danger');
        }
    }

    async function iniciarScrapingCooper() {
        if (isScraping) { showToast('Um processo de scraping já está em andamento.', 'info'); return; }
        const page = document.getElementById('scraping-page').value;
        const item = document.getElementById('scraping-item').value;
        const categoria = document.getElementById('scraping-categoria').value;
        const form = document.getElementById('form-scraping');
        const button = form.querySelector('button');
        const inputs = form.querySelectorAll('input');
        const progressContainer = document.getElementById('scraping-progress-container');
        const progressBar = progressContainer.querySelector('.progress-bar');
        isScraping = true;
        button.disabled = true;
        inputs.forEach(input => input.disabled = true);
        progressBar.style.transition = 'none';
        progressBar.style.width = '0%';
        progressContainer.classList.remove('d-none');
        try {
            const url = `http://localhost:8080/scraping/cooper/${page}&${item}&${categoria}`;
            const response = await fetch(url);
            if (!response.ok || response.status !== 204) { throw new Error(await response.text() || `Falha ao iniciar o scraping (Status: ${response.status})`); }
            showToast('Processo de scraping iniciado.', 'success');
            const duration = 5000; // Duração da simulação reduzida para 5 segundos
            setTimeout(() => { progressBar.style.transition = `width ${duration / 1000}s ease-in-out`; progressBar.style.width = '90%'; }, 100);
            setTimeout(() => {
                progressBar.style.transition = 'width 0.5s ease-in-out';
                progressBar.style.width = '100%';
                carregarProdutos().then(() => {
                    showToast('Lista de produtos atualizada!', 'success');
                    setTimeout(() => {
                        progressContainer.classList.add('d-none');
                        button.disabled = false;
                        inputs.forEach(input => input.disabled = false);
                        isScraping = false;
                    }, 500);
                });
            }, duration);
        } catch (error) {
            console.error('Erro ao iniciar scraping:', error);
            showToast(error.message, 'danger');
            progressContainer.classList.add('d-none');
            button.disabled = false;
            inputs.forEach(input => input.disabled = false);
            isScraping = false;
        }
    }

    async function criarNovaReferencia(event) {
        event.preventDefault();
        const form = document.getElementById('form-criar-referencia');
        const button = form.querySelector('button[type="submit"]');
        const produtoReferencia = {
            nome: document.getElementById('ref-create-nome').value,
            marca: document.getElementById('ref-create-marca').value,
            urlImg: document.getElementById('ref-create-urlImg').value,
            descricao: document.getElementById('ref-create-descricao').value,
            unidadeMedida: document.getElementById('ref-create-unidadeMedida').value,
            valorMedida: parseFloat(document.getElementById('ref-create-valorMedida').value) || null,
            codigoBarra: document.getElementById('ref-create-codigoBarra').value
        };
        button.disabled = true;
        try {
            const response = await fetch('http://localhost:8080/scraping/criar/referencia', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(produtoReferencia)
            });
            if (response.ok) {
                showToast('Referência criada com sucesso!', 'success');
                form.reset();
                const collapseElement = document.getElementById('collapseTwo');
                const bsCollapse = new bootstrap.Collapse(collapseElement, { toggle: false });
                bsCollapse.hide();
                await carregarReferencias();
            } else {
                const errorText = await response.text();
                throw new Error(errorText || 'Erro ao criar referência');
            }
        } catch (error) {
            console.error('Erro ao criar referência:', error);
            showToast(error.message, 'danger');
        } finally {
            button.disabled = false;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js';
        document.body.appendChild(script);

        carregarReferencias().then(carregarProdutos);

        document.getElementById('search-input').addEventListener('input', (e) => { buscarESugerirReferencias(e.target.value); });
        document.getElementById('update-button').addEventListener('click', atualizarProduto);
        document.getElementById('form-scraping').addEventListener('submit', (e) => { e.preventDefault(); iniciarScrapingCooper(); });
        document.getElementById('form-criar-referencia').addEventListener('submit', criarNovaReferencia);
    });
</script>
</body>
</html>
